# åŒæ€ç®—æ³•

**æ•°æ®ä¸å‡ºåŸŸã€å¯ç”¨ä¸å¯è§**

## èƒŒæ™¯

éšç€å¤§æ•°æ®ä¸äººå·¥æ™ºèƒ½çš„å¿«é€Ÿå‘å±•ï¼Œä¸ªäººéšç§æ•°æ®æ³„éœ²å’Œæ»¥ç”¨æ—¶æœ‰å‘ç”Ÿï¼Œéšç§å®‰å…¨é—®é¢˜ä¹Ÿè¶Šæ¥è¶Šè¢«é‡è§†ã€‚

å›½å®¶äº 2020 å¹´æ–½è¡Œå¯†ç æ³•ã€2021 å¹´æ–½è¡Œä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ï¼Œå¯¹ä¸ªäººéšç§æ•°æ®å’Œæ•°æ®å®‰å…¨åŠ å¯†æœ‰æ›´é«˜çš„è¦æ±‚ã€‚

å› æ­¤ï¼Œéšç§è®¡ç®—ä¹Ÿä¸æ–­åœ°è¢«æåŠå’Œå…³æ³¨ï¼Œæºäºå…¶æœ‰ä¼˜ç§€çš„æ•°æ®ä¿æŠ¤ä½œç”¨ï¼Œä½¿å¾—ã€æ•°æ®ä¸å‡ºåŸŸï¼Œå¯ç”¨ä¸å¯è§ã€ï¼Œé™å®šäº†æ•°æ®çš„ä½¿ç”¨åœºæ™¯ï¼Œé˜²æ­¢äº†æ•°æ®çš„æ³„éœ²ï¼Œè€Œå¼•èµ·äº†ä¸šç•Œçš„çƒ­æ§ã€‚

éšç§è®¡ç®—æ˜¯æŒ‡åœ¨ä¿æŠ¤æ•°æ®æœ¬èº«ä¸å¯¹å¤–æ³„éœ²çš„å‰æä¸‹ï¼Œå®ç°æ•°æ®å…±äº«å’Œè®¡ç®—çš„æŠ€æœ¯é›†åˆï¼Œå…±äº«æ•°æ®ä»·å€¼ï¼Œè€Œéæºæ•°æ®æœ¬èº«ï¼Œå®ç°æ•°æ®å¯ç”¨ä¸å¯è§ã€‚

- éšç§è®¡ç®—å¯¹äºä¸ªäººç”¨æˆ·æ¥è¯´ï¼Œæœ‰åŠ©äºä¿éšœä¸ªäººä¿¡æ¯å®‰å…¨ï¼›
- å¯¹äºä¼ä¸šæ¥è¯´ï¼Œéšç§è®¡ç®—æ˜¯æ•°æ®åä½œè¿‡ç¨‹ä¸­å±¥è¡Œæ•°æ®ä¿æŠ¤ä¹‰åŠ¡çš„å…³é”®è·¯å¾„ï¼›
- å¯¹äºæ”¿åºœæ¥è¯´ï¼Œéšç§è®¡ç®—å®ç°æ•°æ®ä»·å€¼æœ€å¤§åŒ–çš„é‡è¦æ”¯æ’‘ã€‚

éšç§è®¡ç®—ç›®å‰åœ¨é‡‘èã€åŒ»ç–—ã€ç”µä¿¡ã€æ”¿åŠ¡ç­‰é¢†åŸŸå‡åœ¨å¼€å±•åº”ç”¨è¯•éªŒï¼Œæ¯”å¦‚ï¼š

* é“¶è¡Œå’Œé‡‘èæœºæ„ï¼š åœ¨ä¸æ³„éœ²å„æ–¹åŸå§‹æ•°æ®çš„å‰æä¸‹ï¼Œè¿›è¡Œåˆ†å¸ƒå¼æ¨¡å‹è®­ç»ƒï¼Œå¯ä»¥æœ‰æ•ˆé™ä½ä¿¡è´·ã€æ¬ºè¯ˆç­‰é£é™©ï¼›
* åŒ»ç–—æœºæ„ï¼š æ— éœ€å…±äº«åŸå§‹æ•°æ®ä¾¿å¯è¿›è¡Œè”åˆå»ºæ¨¡å’Œæ•°æ®åˆ†æï¼Œæ•°æ®ä½¿ç”¨æ–¹åœ¨ä¸ä¾µçŠ¯ç”¨æˆ·éšç§çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨å»ºæ¨¡è¿ç®—ç»“æœæ•°æ®ï¼Œæœ‰æ•ˆæ¨åŠ¨åŒ»ç–—è¡Œä¸šæ•°æ®é«˜æ•ˆåˆ©ç”¨ã€‚

éšç§è®¡ç®—çš„ç›¸å…³æŠ€æœ¯æœ‰å¤šæ–¹å®‰å…¨è®¡ç®—ï¼ˆMPCï¼‰ã€å¯ä¿¡æ‰§è¡Œç¯å¢ƒï¼ˆTEEï¼‰ã€è”é‚¦å­¦ä¹ ï¼ˆFLï¼‰ã€åŒæ€åŠ å¯†ï¼ˆHEï¼‰ã€å·®åˆ†éšç§ï¼ˆDPï¼‰ã€é›¶çŸ¥è¯†è¯æ˜ï¼ˆZKPï¼‰ã€åŒºå—é“¾ï¼ˆBCï¼‰ç­‰ç­‰ã€‚

è¿™äº›æŠ€æœ¯å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œéšç§è®¡ç®—çš„äº§å“æˆ–è€…å¹³å°ä¹Ÿæ˜¯ç”±è¿™äº›æŠ€æœ¯æ¥æ­å»ºã€‚

å…¶ä¸­ä¸å¯†ç å­¦æ˜æ˜¾ç›¸å…³çš„æ˜¯åŒæ€åŠ å¯†ï¼Œç›®å‰åŒæ€åŠ å¯†ç®—æ³•çš„å¼€æºé¡¹ç›®å„æœ‰åƒç§‹ï¼Œç”¨æˆ·ä½¿ç”¨æ¯”è¾ƒå¤æ‚ã€‚Tongsuo ä½œä¸ºåŸºç¡€å¯†ç åº“ï¼Œåº”è¯¥æä¾›ä¸€å¥—ç®€å•æ˜“ç”¨å’Œé«˜æ•ˆçš„åŒæ€åŠ å¯†ç®—æ³•å®ç°å’Œæ¥å£ï¼Œè®©ä¸Šå±‚åº”ç”¨æ›´æ–¹ä¾¿ç®€å•åœ°ä½¿ç”¨åŒæ€åŠ å¯†ç®—æ³•ã€‚

## åŒæ€åŠ å¯†

åŒæ€åŠ å¯†ï¼ˆHomomorphic Encryption, HEï¼‰æ˜¯æŒ‡æ»¡è¶³å¯†æ–‡åŒæ€è¿ç®—æ€§è´¨çš„åŠ å¯†ç®—æ³•ï¼ŒæŒ‰æ€§è´¨åˆ†ä¸ºåŠ æ³•åŒæ€å’Œä¹˜æ³•åŒæ€ï¼š

**åŠ æ³•åŒæ€**

![HE add](images/tongsuo_he_add.png)

**ä¹˜æ³•åŒæ€**

![HE mul](images/tongsuo_he_mul.png)

åŒæ€åŠ å¯†åå¾—åˆ°å¯†æ–‡æ•°æ®ï¼Œå¯¹å¯†æ–‡æ•°æ®è¿›è¡ŒåŒæ€åŠ æ³•æˆ–è€…ä¹˜æ³•å¾—åˆ°å¯†æ–‡ç»“æœï¼Œå°†å¯†æ–‡ç»“æœåŒæ€è§£å¯†åå¯ä»¥å¾—åˆ°åŸå§‹æ•°æ®ç›´æ¥åŠ æ³•æˆ–è€…ä¹˜æ³•çš„è®¡ç®—ç»“æœã€‚

å¦‚ä¸‹å›¾ï¼š

![HE](images/tongsuo_he.png)

æ ¹æ®æ»¡è¶³åŠ æ³•å’Œä¹˜æ³•çš„è¿ç®—æ¬¡æ•°åˆåˆ†ä¸ºï¼šå…¨åŒæ€åŠ å¯†å’ŒåŠåŒæ€åŠ å¯†ã€‚


- å…¨åŒæ€åŠ å¯†ï¼ˆFully Homomorphic Encryption, FHEï¼‰

    * æ”¯æŒä»»æ„æ¬¡çš„åŠ æ³•å’Œä¹˜æ³•è¿ç®—
    * éš¾å®ç°ã€æ€§èƒ½å·®ï¼ˆå¯†é’¥è¿‡å¤§ï¼Œè¿è¡Œæ•ˆç‡ä½ï¼Œå¯†æ–‡è¿‡å¤§ï¼‰
    * ä¸»æµç®—æ³•ï¼šGentryã€BFVã€BGVã€CKKS

- åŠåŒæ€åŠ å¯†ï¼ˆPartially Homomorphic Encryption, PHEï¼‰

    * åªæ”¯æŒåŠ æ³•æˆ–ä¹˜æ³•ä¸­çš„ä¸€ç§è¿ç®—ï¼Œæˆ–è€…å¯åŒæ—¶æ”¯æŒæœ‰é™æ¬¡æ•°çš„åŠ æ³•å’Œä¹˜æ³•è¿ç®—
    * åŸç†ç®€å•ã€æ˜“å®ç°ã€æ€§èƒ½å¥½
    * ä¸»æµç®—æ³•ï¼šRSAã€ElGamalã€Paillier

åŠåŒæ€åŠ å¯†éœ€è¦å®ç°çš„æ¥å£ï¼š

* KeyGen()ï¼šå¯†é’¥ç”Ÿæˆç®—æ³•ï¼Œç”¨äºäº§ç”ŸåŠ å¯†æ•°æ®çš„å…¬é’¥ PKï¼ˆPublic Keyï¼‰å’Œç§é’¥ SKï¼ˆSecret Keyï¼‰ï¼Œä»¥åŠä¸€äº›å…¬å…±å‚æ•° PPï¼ˆPublic Parameterï¼‰ã€‚
* Encrypt()ï¼šåŠ å¯†ç®—æ³•ï¼Œä½¿ç”¨ PK å¯¹ç”¨æˆ·æ•°æ® Data è¿›è¡ŒåŠ å¯†ï¼Œå¾—åˆ°å¯†æ–‡ CTï¼ˆCiphertextï¼‰ã€‚
* Decrypt()ï¼šè§£å¯†ç®—æ³•ï¼Œä½¿ç”¨ SK å¯¹å¯†æ–‡ CT è§£å¯†å¾—åˆ°æ•°æ®åŸæ–‡ PTï¼ˆPlaintextï¼‰ã€‚
* Add()ï¼šå¯†æ–‡åŒæ€åŠ æ³•ï¼Œè¾“å…¥ä¸¤ä¸ª CT è¿›è¡ŒåŒæ€åŠ è¿ç®—ã€‚
* Sub()ï¼šå¯†æ–‡åŒæ€å‡æ³•ï¼Œè¾“å…¥ä¸¤ä¸ª CT è¿›è¡ŒåŒæ€å‡æ³•ç®—ã€‚
* ScalaMul() æˆ–è€… Mul()ï¼šå¯†æ–‡åŒæ€æ ‡é‡ä¹˜æ³•ï¼Œè¾“å…¥ä¸€ä¸ª CT å’Œä¸€ä¸ªæ ‡é‡ PTï¼Œè®¡ç®— CT çš„æ ‡é‡ä¹˜ç»“æœã€‚

## åŠåŒæ€ç®—æ³• EC-ElGamal

ElGamal åŠ å¯†ç®—æ³•æ˜¯åŸºäº Diffie-Hellman å¯†é’¥äº¤æ¢çš„éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼ŒEC-ElGamal æ˜¯ ECC çš„ä¸€ç§ï¼Œæ˜¯æŠŠ ElGamal ç§»æ¤åˆ°æ¤­åœ†æ›²çº¿ä¸Šæ¥çš„å®ç°ï¼Œä¸»è¦è®¡ç®—æœ‰ï¼šæ¤­åœ†æ›²çº¿ç‚¹åŠ ã€ç‚¹å‡ã€ç‚¹ä¹˜ã€æ¨¡é€†å’Œç¦»æ•£å¯¹æ•°ã€‚

ä»¥ä¸‹æ˜¯é“œé”ä¸­å®ç°çš„ç›¸å…³æ¥å£ï¼š

> ğŸŸ¢ **ä¸Šä¸‹æ–‡å¯¹è±¡**

EC_ELGAMAL_CTXï¼Œè¯¥å¯¹è±¡ç”¨æ¥ä¿å­˜å…¬ç§é’¥ä»¥åŠä¸€äº›å…¶ä»–å†…éƒ¨ç”¨åˆ°çš„ä¿¡æ¯ï¼Œæ˜¯ EC-ElGamal ç®—æ³•å…¶ä»–æ¥å£çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚

æ¥å£å¦‚ä¸‹ï¼š

```c
//åˆ›å»º EC_ELGAMAL_CTX å¯¹è±¡ï¼Œkey ä¸º ECC å…¬é’¥æˆ–è€…ç§é’¥çš„ EC_KEY å¯¹è±¡
EC_ELGAMAL_CTX *EC_ELGAMAL_CTX_new(EC_KEY *key);

//é‡Šæ”¾ EC_ELGAMAL_CTX å¯¹è±¡
void EC_ELGAMAL_CTX_free(EC_ELGAMAL_CTX *ctx);
```

> ğŸŸ¢ **è§£å¯†è¡¨å¯¹è±¡**

EC_ELGAMAL_DECRYPT_TABLEï¼Œè¯¥å¯¹è±¡ç”¨æ¥ä¿å­˜è§£å¯†è¡¨çš„å†…éƒ¨ä¿¡æ¯ã€‚æ¤­åœ†æ›²çº¿ç¦»æ•£å¯¹æ•°é—®é¢˜ï¼ˆECDLPï¼‰åªæœ‰çˆ†åŠ›ç ´è§£çš„æ–¹æ³•å¯æ±‚è§£ï¼Œè€Œçˆ†åŠ›ç ´è§£çš„é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œé€šå¸¸çš„åšæ³•æ˜¯ä½¿ç”¨å°æ­¥å¤§æ­¥ç®—æ³•ï¼ˆBaby-Stepï¼ŒGiant-Stepï¼ŒBSGSï¼‰ã€‚æ€»ä½“æ€æƒ³æ˜¯æå‰å°†æ‰€æœ‰å¯èƒ½çš„æ˜æ–‡ç»“æœæå‰è¿ç®—åï¼Œä¿å­˜åˆ° hash è¡¨ä¸­ï¼Œä¸‹æ¬¡åªéœ€è¦è¿›è¡Œå°‘é‡çš„è¿ç®—å’Œ hash è¡¨æŸ¥æ‰¾å°±å¯ä»¥å¾—åˆ°ç»“æœï¼Œå¤§å¤§æé«˜ ECDLP çš„è§£å¯†æ•ˆç‡ã€‚ä½†è§£å¯†è¡¨çš„åˆå§‹åŒ–å¯èƒ½æ¯”è¾ƒæ…¢ï¼Œè€Œä¸”è§£å¯†è¡¨çš„å®ç°äº‹å…³è§£å¯†é€Ÿåº¦ï¼Œåé¢è€ƒè™‘å¯ä»¥å¼€æ”¾æ¥å£çš„å®ç°ç»™ä¸Šå±‚åº”ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆå®šä¹‰äº†ä¸€ä¸ªè§£å¯†è¡¨çš„å¯¹è±¡å’Œé»˜è®¤å®ç°ã€‚

æ¥å£å¦‚ä¸‹ï¼š

```c
//åˆ›å»º EC_ELGAMAL_DECRYPT_TABLE å¯¹è±¡
//decrypt_negative ä¸º 1 æ—¶è¡¨ç¤ºè¯¥è§£å¯†è¡¨å¯ä»¥è§£å¯†è´Ÿæ•°ï¼Œ
//åˆå§‹åŒ–è§£å¯†è¡¨æ—¶å°†å¯èƒ½çš„è´Ÿæ•°è¿ç®—åæ’å…¥åˆ° hash ä¸­ã€‚
EC_ELGAMAL_DECRYPT_TABLE *
EC_ELGAMAL_DECRYPT_TABLE_new(EC_ELGAMAL_CTX *ctx, int32_t decrypt_negative);

//é‡Šæ”¾ EC_ELGAMAL_DECRYPT_TABLE å¯¹è±¡
void EC_ELGAMAL_DECRYPT_TABLE_free(EC_ELGAMAL_DECRYPT_TABLE *table);

//è®¾ç½® EC_ELGAMAL_DECRYPT_TABLE å¯¹è±¡åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­
//è§£å¯†æ—¶å¦‚æœå­˜åœ¨è§£å¯†è¡¨åˆ™ä½¿ç”¨è§£å¯†è¡¨è¿›è¡Œæ±‚è§£ï¼Œå¦åˆ™ç›´æ¥çˆ†åŠ›ç ´è§£ï¼Œé€Ÿåº¦ä¼šå¾ˆæ…¢
void EC_ELGAMAL_CTX_set_decrypt_table(EC_ELGAMAL_CTX *ctx,
                                      EC_ELGAMAL_DECRYPT_TABLE *table);
```

> ğŸŸ¢ **å¯†æ–‡å¯¹è±¡**

EC_ELGAMAL_CIPHERTEXTï¼Œç”±ä¸Šé¢åŸç†å¯çŸ¥ï¼ŒåŠ å¯†ä¹‹åå¾—åˆ°çš„ç»“æœæ˜¯ä¸¤ä¸ªç‚¹ï¼Œè¯¥å¯¹è±¡æ˜¯ç”¨æ¥ä¿å­˜åŠ å¯†åçš„å¯†æ–‡ä¿¡æ¯ï¼ˆä¸¤ä¸ªç‚¹ï¼‰ï¼ŒåŠ å¯†/è§£å¯†å’Œã€‚

æ¥å£å¦‚ä¸‹ï¼š

```c
//åˆ›å»º EC_ELGAMAL_CIPHERTEXT å¯¹è±¡
EC_ELGAMAL_CIPHERTEXT *EC_ELGAMAL_CIPHERTEXT_new(EC_ELGAMAL_CTX *ctx);

//é‡Šæ”¾ EC_ELGAMAL_CIPHERTEXT å¯¹è±¡
void EC_ELGAMAL_CIPHERTEXT_free(EC_ELGAMAL_CIPHERTEXT *ciphertext);
```

> ğŸŸ¢ **åŠ å¯†/è§£å¯†æ¥å£**

```c
//åŠ å¯†ï¼Œå°†æ˜æ–‡ plaintext è¿›è¡ŒåŠ å¯†ï¼Œç»“æœä¿å­˜åˆ° EC_ELGAMAL_CIPHERTEXT å¯¹è±¡æŒ‡é’ˆ r ä¸­
int EC_ELGAMAL_encrypt(EC_ELGAMAL_CTX *ctx,
        EC_ELGAMAL_CIPHERTEXT *r, int32_t plaintext);

//è§£å¯†ï¼Œå°†å¯†æ–‡ ciphertext è¿›è¡Œè§£å¯†ï¼Œç»“æœä¿å­˜åˆ° int32_t æŒ‡é’ˆ r ä¸­
int EC_ELGAMAL_decrypt(EC_ELGAMAL_CTX *ctx,
        int32_t *r, EC_ELGAMAL_CIPHERTEXT *ciphertext);
```

> ğŸŸ¢ **å¯†æ–‡åŠ /å‡/æ ‡é‡ä¹˜è¿ç®—æ¥å£**

```c
//å¯†æ–‡åŠ ï¼Œr = c1 + c2
int EC_ELGAMAL_add(EC_ELGAMAL_CTX *ctx, EC_ELGAMAL_CIPHERTEXT *r,
                   EC_ELGAMAL_CIPHERTEXT *c1, EC_ELGAMAL_CIPHERTEXT *c2);

//å¯†æ–‡å‡ï¼Œr = c1 - c2
int EC_ELGAMAL_sub(EC_ELGAMAL_CTX *ctx, EC_ELGAMAL_CIPHERTEXT *r,
                   EC_ELGAMAL_CIPHERTEXT *c1, EC_ELGAMAL_CIPHERTEXT *c2);

//æ ‡é‡å¯†æ–‡ä¹˜ï¼Œr = m * c
int EC_ELGAMAL_mul(EC_ELGAMAL_CTX *ctx, EC_ELGAMAL_CIPHERTEXT *r,
                   EC_ELGAMAL_CIPHERTEXT *c, int32_t m);
```

> ğŸŸ¢ **ç¼–ç /è§£ç æ¥å£**

åŒæ€åŠ å¯†æ¶‰åŠåˆ°å¤šæ–¹å‚ä¸ï¼Œå¯èƒ½ä¼šéœ€è¦ç½‘ç»œä¼ è¾“ï¼Œè¿™å°±å°†å¯†æ–‡å¯¹è±¡ EC_ELGAMAL_CIPHERTEXT ç¼–ç åæ‰èƒ½ä¼ é€’ç»™å¯¹æ–¹ï¼Œå¯¹æ–¹ä¹Ÿéœ€è¦è§£ç å¾—åˆ° EC_ELGAMAL_CIPHERTEXT å¯¹è±¡åæ‰èƒ½è°ƒç”¨å…¶ä»–æ¥å£è¿›è¡Œè¿ç®—ã€‚

æ¥å£å¦‚ä¸‹ï¼š

```c
//ç¼–ç ï¼Œå°†å¯†æ–‡ ciphertext ç¼–ç åä¿å­˜åˆ° out æŒ‡é’ˆä¸­ï¼Œout æŒ‡é’ˆçš„å†…å­˜éœ€è¦æå‰åˆ†é…å¥½ï¼›
//å¦‚æœ out ä¸º NULLï¼Œåˆ™è¿”å›ç¼–ç æ‰€éœ€çš„å†…å­˜å¤§å°ï¼›
//compressed ä¸ºæ˜¯å¦é‡‡ç”¨å‹ç¼©æ–¹å¼ç¼–ç 
//  1 ä¸ºå‹ç¼©ç¼–ç ï¼ˆç¼–ç ç»“æœé•¿åº¦è¾ƒå°ï¼‰
//  0 ä¸ºæ­£å¸¸ç¼–ç ï¼ˆç¼–ç ç»“æœé•¿åº¦è¾ƒå¤§ï¼‰
size_t EC_ELGAMAL_CIPHERTEXT_encode(EC_ELGAMAL_CTX *ctx,
        unsigned char *out, size_t size,
        EC_ELGAMAL_CIPHERTEXT *ciphertext, int compressed);

//è§£ç ï¼Œå°†é•¿åº¦ä¸º size çš„å†…å­˜æ•°æ® in è§£ç åä¿å­˜åˆ°å¯†æ–‡å¯¹è±¡ r ä¸­
int EC_ELGAMAL_CIPHERTEXT_decode(EC_ELGAMAL_CTX *ctx,
        EC_ELGAMAL_CIPHERTEXT *r, unsigned char *in, size_t size);
```

### æ ¸å¿ƒå®ç°

Tongsuo æ˜¯ OpenSSL çš„è¡ç”Ÿç‰ˆï¼Œå†…éƒ¨æ”¯æŒäº†å¾ˆå¤šæ¤­åœ†æ›²çº¿ç®—æ³•çš„å®ç°ã€‚

æ¯”å¦‚ï¼Œå·²æ”¯æŒå›½é™…ï¼ˆprime256v1ã€secp384r1 ç­‰ï¼‰å’Œå›½å¯†ï¼ˆSM2ï¼‰çš„å¤§éƒ¨åˆ†æ¤­åœ†æ›²çº¿ï¼Œå¤©ç”Ÿå®ç°äº†æ¤­åœ†æ›²çº¿ç‚¹è¿ç®—ã€å…¬ç§é’¥ç”Ÿæˆç­‰åŸºç¡€ç®—æ³•ï¼Œæ‰€ä»¥åœ¨ Tongsuo å®ç° EC-ElGamal ç®—æ³•çš„æ ¸å¿ƒå®ç°ä¸»è¦æ˜¯ EC-ElGamal åŸç†çš„å®ç°å’Œ ECDLP æ±‚è§£ç®—æ³•çš„å®ç°ã€‚

## åŠåŒæ€ç®—æ³• Paillier

Paillier å’Œ EC-ElGamal åŠåŒæ€åŠ å¯†ç®—æ³•ï¼Œæ˜¯éšç§è®¡ç®—é¢†åŸŸåº”ç”¨æ¯”è¾ƒå¹¿æ³›çš„ä¸¤ä¸ªç®—æ³•ï¼Œå®ƒä»¬æ¥å£ç±»ä¼¼ä¸”åªæ”¯æŒåŠ æ³•åŒæ€ã€‚

ä½†æ˜¯å®ƒä»¬ä¸¤è€…çš„æ€§èƒ½å’ŒåŸç†æœ‰å¾ˆå¤§çš„å·®å¼‚ï¼š

**åŸç†æ–¹é¢**ï¼ŒPaillier æ˜¯åŸºäºå¤åˆå‰©ä½™ç±»çš„å›°éš¾æ€§é—®é¢˜ ï¼ˆå¤§æ•°åˆ†è§£éš¾é¢˜ï¼‰ çš„å…¬é’¥åŠ å¯†ç®—æ³•ï¼Œæœ‰ç‚¹ç±»ä¼¼ RSAï¼›è€Œ EC-ElGamal æ˜¯åŸºäºæ¤­åœ†æ›²çº¿æ•°å­¦ç†è®ºçš„å…¬é’¥åŠ å¯†ç®—æ³•ï¼Œå…¶å®‰å…¨æ€§ç†è®ºä¸Šè¦æ¯” Paillier è¦æ›´å¥½ã€‚

**æ€§èƒ½æ–¹é¢**ï¼ŒEC-ElGamal çš„åŠ å¯†å’Œå¯†æ–‡åŠ æ³•æ€§èƒ½è¦æ¯” Paillier å¥½ï¼›è€Œ Paillier çš„è§£å¯†å’Œå¯†æ–‡æ ‡é‡ä¹˜æ³•æ€§èƒ½è¦æ¯”èµ· EC-ElGamal è¦æ›´å¥½æ›´ç¨³å®š ï¼ˆEC-ElGamal çš„è§£å¯†æ€§èƒ½ä¸è§£å¯†çš„æ•°å­—å¤§å°æœ‰å…³ç³»ï¼Œæ•°å­—è¶Šå¤§å¯èƒ½éœ€è¦è§£å¯†çš„æ—¶é—´è¶Šé•¿ï¼Œè¿™ä¸ EC-ElGamal è§£å¯†ç”¨åˆ°çš„è§£å¯†è¡¨æœ‰å…³ç³»ï¼Œè€Œ Paillier çš„è§£å¯†å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚ï¼‰ ã€‚

æ‰€ä»¥è¿™ä¸¤ä¸ªç®—æ³•å„æœ‰ä¼˜åŠ£ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©ä½¿ç”¨ Paillier è¿˜æ˜¯ EC-ElGamalã€‚

ä»¥ä¸‹æ˜¯é“œé”ä¸­å®ç°çš„ç›¸å…³æ¥å£ï¼š

> ğŸŸ¢ **å¯¹è±¡ç›¸å…³æ¥å£**

**å…¬/ç§é’¥å¯¹è±¡**ï¼šPAILLIER_KEY ï¼Œè¯¥å¯¹è±¡ç”¨æ¥ä¿å­˜ Paillier å…¬é’¥å’Œç§é’¥çš„åŸºæœ¬ä¿¡æ¯ï¼Œæ¯”å¦‚ pã€qã€nã€gã€Î»ã€Î¼ ç­‰ä¿¡æ¯ï¼Œç§é’¥ä¿å­˜æ‰€æœ‰å­—æ®µï¼Œå…¬é’¥åªä¿å­˜ nã€gï¼Œå…¶ä»–å­—æ®µä¸ºç©ºæˆ–è€… 0ã€‚ç›¸å…³æ¥å£å¦‚ä¸‹ï¼š

```c
// åˆ›å»º PAILLIER_KEY å¯¹è±¡
PAILLIER_KEY *PAILLIER_KEY_new(void);

// é‡Šæ”¾ PAILLIER_KEY å¯¹è±¡
void PAILLIER_KEY_free(PAILLIER_KEY *key);

// æ‹·è´ PAILLIER_KEY å¯¹è±¡ï¼Œå°† src æ‹·è´åˆ° dest ä¸­
PAILLIER_KEY *PAILLIER_KEY_copy(PAILLIER_KEY *dest, PAILLIER_KEY *src);

// å¤åˆ¶ PAILLIER_KEY å¯¹è±¡
PAILLIER_KEY *PAILLIER_KEY_dup(PAILLIER_KEY *key);

// å°† PAILLIER_KEY å¯¹è±¡å¼•ç”¨è®¡æ•°åŠ 1ï¼Œé‡Šæ”¾ PAILLIER_KEY å¯¹è±¡æ—¶è‹¥å¼•ç”¨è®¡æ•°ä¸ä¸º0åˆ™ä¸èƒ½é‡Šæ”¾å…¶å†…å­˜
intPAILLIER_KEY_up_ref(PAILLIER_KEY *key);

// ç”Ÿæˆ PAILLIER_KEY å¯¹è±¡ä¸­çš„å‚æ•°ï¼Œbits ä¸ºéšæœºå¤§ç´ æ•° pã€q çš„äºŒè¿›åˆ¶ä½é•¿åº¦
int PAILLIER_KEY_generate_key(PAILLIER_KEY *key, int bits);

// è·å– key çš„ç±»å‹ï¼šå…¬é’¥ or ç§é’¥
// PAILLIER_KEY_TYPE_PUBLIC ä¸ºç§é’¥ï¼ŒPAILLIER_KEY_TYPE_PRIVATE ä¸ºç§é’¥
int PAILLIER_KEY_type(PAILLIER_KEY *key);
```

**ä¸Šä¸‹æ–‡å¯¹è±¡**ï¼šPAILLIER_CTXï¼Œè¯¥å¯¹è±¡ç”¨æ¥ä¿å­˜å…¬ç§é’¥å¯¹è±¡ä»¥åŠä¸€äº›å…¶ä»–å†…éƒ¨ç”¨åˆ°çš„ä¿¡æ¯ï¼Œæ˜¯ Paillier ç®—æ³•å…¶ä»–æ¥å£çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚ç›¸å…³æ¥å£å¦‚ä¸‹ï¼š

```c
// åˆ›å»º PAILLIER_CTX å¯¹è±¡ï¼Œkey ä¸º paillier å…¬é’¥æˆ–è€…ç§é’¥ï¼Œ
// threshold ä¸ºæ”¯æŒæœ€å¤§çš„æ•°å­—é˜ˆå€¼ï¼ŒåŠ å¯†åœºæ™¯å¯è®¾ç½®ä¸º 0ï¼Œè§£å¯†åœºæ™¯å¯ä½¿ç”¨é»˜è®¤å€¼ï¼š
PAILLIER_MAX_THRESHOLDPAILLIER_CTX *
PAILLIER_CTX_new(PAILLIER_KEY *key, int64_t threshold);

// é‡Šæ”¾ PAILLIER_CTX å¯¹è±¡
void PAILLIER_CTX_free(PAILLIER_CTX *ctx);

// æ‹·è´ PAILLIER_CTX å¯¹è±¡ï¼Œå°† src æ‹·è´åˆ° dest ä¸­
PAILLIER_CTX *PAILLIER_CTX_copy(PAILLIER_CTX *dest, PAILLIER_CTX *src);

// å¤åˆ¶ PAILLIER_CTX å¯¹è±¡
PAILLIER_CTX *PAILLIER_CTX_dup(PAILLIER_CTX *src);
```

**å¯†æ–‡å¯¹è±¡**ï¼šPAILLIER_CIPHERTEXT ï¼Œè¯¥å¯¹è±¡æ˜¯ç”¨æ¥ä¿å­˜ Paillier åŠ å¯†åçš„ç»“æœä¿¡æ¯ï¼Œç”¨åˆ° PAILLIER_CIPHERTEXT çš„åœ°æ–¹ï¼Œå¯è°ƒç”¨å¦‚ä¸‹æ¥å£ï¼š

```c
// åˆ›å»º PAILLIER_CIPHERTEXT å¯¹è±¡
PAILLIER_CIPHERTEXT *PAILLIER_CIPHERTEXT_new(PAILLIER_CTX *ctx);

// é‡Šæ”¾ PAILLIER_CIPHERTEXT å¯¹è±¡
void PAILLIER_CIPHERTEXT_free(PAILLIER_CIPHERTEXT *ciphertext);
```

> ğŸŸ¢ **åŠ å¯†/è§£å¯†æ¥å£**

```c
// åŠ å¯†ï¼Œå°†æ˜æ–‡ m è¿›è¡ŒåŠ å¯†ï¼Œç»“æœä¿å­˜åˆ° PAILLIER_CIPHERTEXT å¯¹è±¡æŒ‡é’ˆ out ä¸­
int PAILLIER_encrypt(PAILLIER_CTX *ctx,
        PAILLIER_CIPHERTEXT *out, int32_t m);

// è§£å¯†ï¼Œå°†å¯†æ–‡ c è¿›è¡Œè§£å¯†ï¼Œç»“æœä¿å­˜åˆ° int32_t æŒ‡é’ˆ out ä¸­
int PAILLIER_decrypt(PAILLIER_CTX *ctx,
        int32_t *out, PAILLIER_CIPHERTEXT *c);
```

> ğŸŸ¢ **å¯†æ–‡åŠ /å‡/æ ‡é‡ä¹˜è¿ç®—æ¥å£**

```c
// å¯†æ–‡åŠ ï¼Œr = c1 + c2
int PAILLIER_add(PAILLIER_CTX *ctx, PAILLIER_CIPHERTEXT *r,
                 PAILLIER_CIPHERTEXT *c1, PAILLIER_CIPHERTEXT *c2);

// å¯†æ–‡æ ‡é‡åŠ ï¼Œr = c1 * m
int PAILLIER_add_plain(PAILLIER_CTX *ctx, PAILLIER_CIPHERTEXT *r,
                       PAILLIER_CIPHERTEXT *c1, int32_t m);

// å¯†æ–‡å‡ï¼Œr = c1 - c2
int PAILLIER_sub(PAILLIER_CTX *ctx, PAILLIER_CIPHERTEXT *r,
                 PAILLIER_CIPHERTEXT *c1, PAILLIER_CIPHERTEXT *c2);

// å¯†æ–‡æ ‡é‡ä¹˜ï¼Œr = c * m
int PAILLIER_mul(PAILLIER_CTX *ctx, PAILLIER_CIPHERTEXT *r,
                 PAILLIER_CIPHERTEXT *c, int32_t m);
```

> ğŸŸ¢ **ç¼–ç /è§£ç æ¥å£**

åŒæ€åŠ å¯†æ¶‰åŠåˆ°å¤šæ–¹å‚ä¸ï¼Œå¯èƒ½ä¼šéœ€è¦ç½‘ç»œä¼ è¾“ï¼Œè¿™å°±éœ€è¦å°†å¯†æ–‡å¯¹è±¡ PAILLIER_CIPHERTEXT ç¼–ç åæ‰èƒ½ä¼ é€’ç»™å¯¹æ–¹ï¼Œå¯¹æ–¹ä¹Ÿéœ€è¦è§£ç å¾—åˆ° PAILLIER_CIPHERTEXT å¯¹è±¡åæ‰èƒ½è°ƒç”¨å…¶ä»–æ¥å£è¿›è¡Œè¿ç®—ã€‚

æ¥å£å¦‚ä¸‹ï¼š

```c
// ç¼–ç ï¼Œå°†å¯†æ–‡ ciphertext ç¼–ç åä¿å­˜åˆ° out æŒ‡é’ˆä¸­ï¼Œout æŒ‡é’ˆçš„å†…å­˜éœ€è¦æå‰åˆ†é…å¥½ï¼›
// å¦‚æœ out ä¸º NULLï¼Œåˆ™è¿”å›ç¼–ç æ‰€éœ€çš„å†…å­˜å¤§å°ï¼›
// flagï¼šæ ‡å¿—ä½ï¼Œé¢„ç•™ï¼Œæš‚æ—¶æ²¡æœ‰ç”¨
size_t PAILLIER_CIPHERTEXT_encode(PAILLIER_CTX *ctx, unsigned char *out, 
                                  size_t size,
                                  const PAILLIER_CIPHERTEXT *ciphertext,
                                  int flag);

// è§£ç ï¼Œå°†é•¿åº¦ä¸º size çš„å†…å­˜æ•°æ® in è§£ç åä¿å­˜åˆ°å¯†æ–‡å¯¹è±¡ r ä¸­
int PAILLIER_CIPHERTEXT_decode(PAILLIER_CTX *ctx, PAILLIER_CIPHERTEXT *r,
                               unsigned char *in, size_t size);
```

### Paillier å‘½ä»¤è¡Œ

ä¸ºäº†æé«˜ Paillier çš„æ˜“ç”¨æ€§ï¼ŒTongsuo å®ç°äº†å¦‚ä¸‹ Paillier å­å‘½ä»¤ï¼š

```shell
$ /opt/tongsuo-debug/bin/openssl paillier -help
Usage: paillier [action options] [input/output options] [arg1] [arg2]

General options:
-help         Display this summary
Action options:
-keygen       Generate a paillier private key
-pubgen       Generate a paillier public key
-key          Display/Parse a paillier private key
-pub          Display/Parse a paillier public key
-encrypt      Encrypt a number with the paillier public key, usage: -encrypt 99, 99 is an example number
-decrypt      Decrypt a ciphertext using the paillier private key, usage:-decrypt c1, c1 is an example ciphertext
-add          Paillier homomorphic addition: add two ciphertexts, usage: -add c1 c2, c1 and c2 are tow example ciphertexts, result: E(c1) + E(c2)
-add_plain    Paillier homomorphic addition: add a ciphertext to a plaintext, usage: -add_plain c1 99, c1 is an example ciphertext, 99 is an example number, result: E(c1) + 99
-sub          Paillier homomorphic subtraction: sub two ciphertexts, usage: -sub c1 c2, c1 and c2 are tow example ciphertexts, result: E(c1) - E(c2)
-mul          Paillier homomorphic scalar multiplication: multiply a ciphertext by a known plaintext, usage: -mul c1 99, c1 is an example ciphertext, 99 is an example number, result: E(c1) * 99

Input options:
-in val       Input file
-key_in val   Input is a paillier private key used to generate public key

Output options:
-out outfile  Output the paillier key to specified file
-noout        Don't print paillier key out
-text         Print the paillier key in text
-verbose      Verbose output

Parameters:
arg1          Argument for encryption/decryption, or the first argument of a homomorphic operation
arg2          The second argument of a homomorphic operation
```

é€šè¿‡ä»¥ä¸Šå‘½ä»¤å³å¯åœ¨å‘½ä»¤è¡Œè¿›è¡Œ Paillier ç®—æ³•å®éªŒï¼Œé™ä½å…¥é—¨é—¨æ§›ã€‚

å¦å¤–è¿˜å®ç°äº† Paillier çš„ speed å‘½ä»¤ï¼Œå¯ä»¥è¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œè¯¦æƒ…è¯·æŸ¥é˜…ç›¸å…³ä»£ç å’Œæ–‡æ¡£ã€‚

{{#template ../template/footer.md}}
