<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>æ–‡ä»¶åŠ å¯†ï¼ˆfscryptï¼‰ - å•†ç”¨å¯†ç æŠ€æœ¯æœ€ä½³å®è·µç™½çš®ä¹¦</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="overview.html">å‰è¨€</a></li><li class="chapter-item "><a href="openanolis.html">OpenAnolis é¾™èœ¥ç¤¾åŒº</a></li><li class="chapter-item "><a href="introduction.html">å›½å¯†ç®€ä»‹ä¸ç°çŠ¶</a></li><li class="chapter-item "><a href="shangmi_sig.html">OpenAnolis å…¨æ ˆå›½å¯†æ¦‚è¿°</a></li><li class="chapter-item "><a href="anolisos_guide.html">Anolis OS å›½å¯†å¼€å‘æŒ‡å—</a></li><li class="chapter-item "><a href="trusted_computing.html">å›½å¯†å¯ä¿¡è®¡ç®—</a></li><li class="chapter-item "><a href="secure_boot.html">å›½å¯†å®‰å…¨å¯åŠ¨</a></li><li class="chapter-item expanded "><a href="linux_kernel.html">Linux å†…æ ¸å›½å¯†æ”¯æŒ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="kernel_shangmi.html">å†…æ ¸å›½å¯†ç®—æ³•</a></li><li class="chapter-item expanded "><a href="kernel_fscrypt.html" class="active">æ–‡ä»¶åŠ å¯†ï¼ˆfscryptï¼‰</a></li><li class="chapter-item "><a href="kernel_dmcrypt.html">ç£ç›˜åŠ å¯†ï¼ˆLUKSï¼‰</a></li><li class="chapter-item "><a href="kernel_ima.html">å†…æ ¸å®Œæ•´æ€§åº¦é‡æ¶æ„ï¼ˆIMAï¼‰</a></li><li class="chapter-item "><a href="kernel_modsign.html">å†…æ ¸æ¨¡å—ç­¾å</a></li><li class="chapter-item "><a href="kernel_tls.html">Kernel TLSï¼ˆKTLSï¼‰å®è·µ</a></li></ol></li><li class="chapter-item "><a href="tongsuo.html">Tongsuoï¼ˆé“œé”ï¼‰å¯†ç åº“</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="tongsuo_tls.html">TLS 1.3 ä½¿ç”¨å•†å¯†å¥—ä»¶</a></li><li class="chapter-item "><a href="tongsuo_dc.html">å§”æ‰˜å‡­è¯</a></li><li class="chapter-item "><a href="tongsuo_cc.html">è¯ä¹¦å‹ç¼©ï¼ˆRFC 8879ï¼‰</a></li><li class="chapter-item "><a href="tongsuo_tlcp.html">TLCP å®‰å…¨ä¼ è¾“åè®®</a></li><li class="chapter-item "><a href="tongsuo_he.html">åŒæ€ç®—æ³•</a></li><li class="chapter-item "><a href="tongsuo_java_sdk.html">Tongsuo-Java-SDK</a></li></ol></li><li class="chapter-item "><a href="crypto_library.html">OpenAnolis å›½å¯†ç®—æ³•åº“</a></li><li class="chapter-item "><a href="dev_practices.html">å›½å¯†åº”ç”¨å¼€å‘å®è·µ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="python_shangmi.html">Python å›½å¯†ç­¾åå®è·µ</a></li><li class="chapter-item "><a href="nginx_tlcp.html">Web æœåŠ¡å›½å¯†åŒè¯ä¹¦æ”¯æŒ</a></li><li class="chapter-item "><a href="wireshark.html">Wireshark å›½å¯†è°ƒè¯•å®è·µ</a></li></ol></li><li class="chapter-item "><a href="optimization.html">å›½å¯†ç¡¬ä»¶åŠ é€Ÿä¸ä¼˜åŒ–</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="optimization_cpu.html">åŸºäº CPU æŒ‡ä»¤é›†çš„å›½å¯†ç®—æ³•ä¼˜åŒ–</a></li><li class="chapter-item "><a href="optimization_hct.html">æµ·å…‰å¯†ç æŠ€æœ¯ï¼ˆHCTï¼‰</a></li><li class="chapter-item "><a href="optimization_montage.html">æ¾œèµ·åŠ è§£å¯†å’Œå¯ä¿¡è®¡ç®—èŠ¯ç‰‡</a></li></ol></li><li class="chapter-item "><a href="contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">å•†ç”¨å¯†ç æŠ€æœ¯æœ€ä½³å®è·µç™½çš®ä¹¦</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="æ–‡ä»¶åŠ å¯†fscrypt"><a class="header" href="#æ–‡ä»¶åŠ å¯†fscrypt">æ–‡ä»¶åŠ å¯†ï¼ˆfscryptï¼‰</a></h1>
<p>é€šå¸¸æˆ‘ä»¬ä¼šä»¥æ–‡ä»¶ä½œä¸ºæ•°æ®è½½ä½“ï¼Œä½¿ç”¨ç£ç›˜ï¼ŒUSB é—ªå­˜ï¼ŒSD å¡ç­‰å­˜å‚¨ä»‹è´¨è¿›è¡Œæ•°æ®å­˜å‚¨ï¼Œå³ä¾¿æ•°æ®å·²ç»ç¦»çº¿å­˜å‚¨ï¼Œä»ç„¶ä¸èƒ½ä¿è¯è¯¥å­˜å‚¨ä»‹è´¨ä¸ä¼šä¸¢å¤±ï¼Œå¦‚æœä¸¢å¤±é‚£ä¹ˆå¯¹äºæˆ‘ä»¬æ¥è¯´æœ‰å¯èƒ½æ˜¯ç¾éš¾æ€§çš„äº‹ä»¶ã€‚å› æ­¤å¯¹è¿™äº›ç¦»çº¿å­˜å‚¨çš„é‡è¦æ•°æ®æ–‡ä»¶è¿›è¡ŒåŠ å¯†æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼Œæœ¬èŠ‚å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨å›½å¯†ç®—æ³•åŠ å¯†æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ã€‚</p>
<h2 id="fscrypt-ç®€ä»‹"><a class="header" href="#fscrypt-ç®€ä»‹">fscrypt ç®€ä»‹</a></h2>
<p>å†…æ ¸ä¸­çš„ fscrypt æ˜¯ä¸€ä¸ªåº“ï¼Œæ–‡ä»¶ç³»ç»Ÿå¯ä»¥ä½¿ç”¨å®ƒä»¥æ”¯æŒæ–‡ä»¶å’Œç›®å½•çš„é€æ˜åŠ å¯†ã€‚</p>
<p>ä¸ dm-crypt ä¸åŒï¼Œfscrypt åœ¨æ–‡ä»¶ç³»ç»Ÿçº§åˆ«è€Œä¸æ˜¯å—è®¾å¤‡çº§åˆ«è¿è¡Œã€‚ è¿™å…è®¸å®ƒä½¿ç”¨ä¸åŒçš„å¯†é’¥åŠ å¯†ä¸åŒçš„æ–‡ä»¶ï¼Œå¹¶åœ¨åŒä¸€æ–‡ä»¶ç³»ç»Ÿä¸Šæ‹¥æœ‰æœªåŠ å¯†çš„æ–‡ä»¶ã€‚ è¿™å¯¹äºå¤šç”¨æˆ·ç³»ç»Ÿéå¸¸æœ‰ç”¨ï¼Œåœ¨è¯¥ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªç”¨æˆ·çš„é™æ€æ•°æ®éƒ½éœ€è¦ä¸å…¶ä»–ç”¨æˆ·è¿›è¡ŒåŠ å¯†éš”ç¦»ã€‚ é™¤äº†æ–‡ä»¶åï¼Œfscrypt ä¸åŠ å¯†æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®ã€‚</p>
<p>ä¸ä½œä¸ºæ ˆå¼æ–‡ä»¶ç³»ç»Ÿçš„ eCryptfs ä¸åŒï¼Œfscrypt æ˜¯ç›´æ¥é›†æˆåˆ°æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œç›®å‰æ”¯æŒ fscrypt çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ ext4ã€F2FS å’Œ UBIFSã€‚fscrypt å…è®¸è¯»å–å’Œå†™å…¥åŠ å¯†æ–‡ä»¶ï¼Œè€Œæ— éœ€åœ¨é¡µé¢ç¼“å­˜ä¸­åŒæ—¶ç¼“å­˜è§£å¯†å’ŒåŠ å¯†é¡µé¢ï¼Œä»è€Œå°†ä½¿ç”¨çš„å†…å­˜å‡ ä¹å‡åŠå¹¶ä½¿å…¶ä¸æœªåŠ å¯†æ–‡ä»¶ä¿æŒä¸€è‡´ã€‚ åŒæ ·ï¼Œéœ€è¦ä¸€åŠçš„ dentry å’Œ inodeã€‚ eCryptfs è¿˜å°†åŠ å¯†æ–‡ä»¶åé™åˆ¶ä¸º 143 å­—èŠ‚ï¼Œä»è€Œå¯¼è‡´åº”ç”¨ç¨‹åºå…¼å®¹æ€§é—®é¢˜ï¼› fscrypt å…è®¸å®Œæ•´çš„ 255 ä¸ªå­—èŠ‚ (NAME_MAX)é•¿åº¦çš„æ–‡ä»¶åã€‚ æœ€åï¼Œä¸ eCryptfs ä¸åŒï¼Œfscrypt API å¯ä»¥ç”±éç‰¹æƒç”¨æˆ·ä½¿ç”¨ï¼Œè€Œæ— éœ€ä¾èµ–å…¶å®ƒä»»ä½•ç»„ä»¶ã€‚</p>
<p>fscrypt ä¸æ”¯æŒå°±åœ°åŠ å¯†æ–‡ä»¶ã€‚ ç›¸åï¼Œå®ƒæ”¯æŒå°†ç©ºç›®å½•æ ‡è®°ä¸ºå·²åŠ å¯†ã€‚ ç„¶åï¼Œåœ¨ç”¨æˆ·ç©ºé—´æä¾›å¯†é’¥åï¼Œåœ¨è¯¥ç›®å½•æ ‘ä¸­åˆ›å»ºçš„æ‰€æœ‰å¸¸è§„æ–‡ä»¶ã€ç›®å½•å’Œç¬¦å·é“¾æ¥éƒ½å°†è¢«é€æ˜åœ°åŠ å¯†ã€‚</p>
<h2 id="æ”¯æŒçš„åŠ å¯†æ¨¡å¼å’Œç”¨æ³•"><a class="header" href="#æ”¯æŒçš„åŠ å¯†æ¨¡å¼å’Œç”¨æ³•">æ”¯æŒçš„åŠ å¯†æ¨¡å¼å’Œç”¨æ³•</a></h2>
<p>fscrypt å…è®¸ä¸ºæ–‡ä»¶å†…å®¹æŒ‡å®šä¸€ç§åŠ å¯†æ¨¡å¼ï¼Œä¸ºæ–‡ä»¶åæŒ‡å®šä¸€ç§åŠ å¯†æ¨¡å¼ã€‚ ä¸åŒçš„ç›®å½•æ ‘å…è®¸ä½¿ç”¨ä¸åŒçš„åŠ å¯†æ–¹å¼ã€‚ ç›®å‰æ”¯æŒä»¥ä¸‹å‡ ç§åŠ å¯†æ–¹å¼å¯¹ï¼š</p>
<ul>
<li>AES-256-XTS ç®—æ³•ç”¨äºåŠ å¯†å†…å®¹ï¼ŒAES-256-CTS-CBC ç®—æ³•ç”¨äºåŠ å¯†æ–‡ä»¶å</li>
<li>AES-128-CBC ç®—æ³•ç”¨äºåŠ å¯†å†…å®¹ï¼ŒAES-128-CTS-CBC ç®—æ³•ç”¨äºåŠ å¯†æ–‡ä»¶å</li>
<li>Adiantum ç®—æ³•åŒæ—¶ç”¨äºåŠ å¯†æ–‡ä»¶å†…å®¹å’Œæ–‡ä»¶å</li>
<li>AES-256-XTS ç®—æ³•ç”¨äºåŠ å¯†å†…å®¹ï¼ŒAES-256-HCTR2 ç®—æ³•ç”¨äºåŠ å¯†æ–‡ä»¶åï¼ˆä»…é™ v2 ç­–ç•¥ï¼‰</li>
<li>SM4-XTS ç®—æ³•ç”¨äºåŠ å¯†å†…å®¹ï¼ŒSM4-CTS-CBC ç®—æ³•ç”¨äºåŠ å¯†æ–‡ä»¶åï¼ˆä»…é™ v2 ç­–ç•¥ï¼‰</li>
</ul>
<p>AES-128-CBC ä»…ä¸ºå…·æœ‰ä¸æ”¯æŒ XTS æ¨¡å¼çš„åŠ é€Ÿå™¨çš„ä½åŠŸè€—åµŒå…¥å¼è®¾å¤‡ä½¿ç”¨ã€‚ è¦ä½¿ç”¨ AES-128-CBCï¼Œå¿…é¡»å¯ç”¨ CONFIG_CRYPTO_ESSIV å’Œ CONFIG_CRYPTO_SHA256ï¼ˆæˆ–å…¶ä»– SHA-256 å®ç°ï¼‰ä»¥ä¾¿ä½¿ç”¨ ESSIVã€‚</p>
<p>Adiantum æ˜¯ä¸€ç§åŸºäºæµå¯†ç çš„æ¨¡å¼ï¼Œå³ä½¿åœ¨æ²¡æœ‰ä¸“ç”¨åŠ å¯†æŒ‡ä»¤çš„ CPU ä¸Šä¹Ÿå¾ˆå¿«ã€‚ ä¸ XTS ä¸åŒï¼Œå®ƒä¹Ÿæ˜¯çœŸæ­£çš„å®½å—æ¨¡å¼ã€‚è¦ä½¿ç”¨ Adiantumï¼Œå¿…é¡»å¯ç”¨ CONFIG_CRYPTO_ADIANTUMã€‚ æ­¤å¤–ï¼Œåº”å¯ç”¨ ChaCha å’Œ NHPoly1305 çš„å¿«é€Ÿå®ç°ï¼Œä¾‹å¦‚ ARM æ¶æ„ä¸Šçš„ CONFIG_CRYPTO_CHACHA20_NEON å’Œ CONFIG_CRYPTO_NHPOLY1305_NEONã€‚</p>
<p>AES-256-HCTR2 æ˜¯å¦ä¸€ç§çœŸæ­£çš„å®½å—åŠ å¯†æ¨¡å¼ï¼Œæ—¨åœ¨ç”¨äºå…·æœ‰ä¸“ç”¨åŠ å¯†æŒ‡ä»¤çš„ CPUã€‚ AES-256-HCTR2 å…·æœ‰æ˜æ–‡ä¸­çš„ä½ç¿»è½¬ä¼šæ›´æ”¹æ•´ä¸ªå¯†æ–‡çš„å±æ€§ã€‚ ç”±äºåˆå§‹åŒ–å‘é‡åœ¨ç›®å½•ä¸­é‡å¤ä½¿ç”¨ï¼Œå› æ­¤æ­¤å±æ€§ä½¿å…¶æˆä¸ºæ–‡ä»¶ååŠ å¯†çš„ç†æƒ³é€‰æ‹©ã€‚ è¦ä½¿ç”¨ AES-256-HCTR2ï¼Œå¿…é¡»å¯ç”¨ CONFIG_CRYPTO_HCTR2ã€‚ æ­¤å¤–ï¼Œåº”å¯ç”¨ XCTR å’Œ POLYVAL çš„å¿«é€Ÿå®ç°ï¼Œä¾‹å¦‚ ç”¨äº ARM64 çš„ CRYPTO_POLYVAL_ARM64_CE å’Œ CRYPTO_AES_ARM64_CE_BLKã€‚</p>
<p>æœ€åæ˜¯ SM4 ç®—æ³•ï¼Œç›®å‰ä»…åœ¨ fscrypt v2 ç­–ç•¥ä¸­å¯ç”¨ã€‚</p>
<h2 id="ä½¿ç”¨-sm4-ç®—æ³•åŠ å¯†æ–‡ä»¶"><a class="header" href="#ä½¿ç”¨-sm4-ç®—æ³•åŠ å¯†æ–‡ä»¶">ä½¿ç”¨ SM4 ç®—æ³•åŠ å¯†æ–‡ä»¶</a></h2>
<blockquote>
<p>ğŸŸ¢ <strong>å‡†å¤‡å·¥ä½œ</strong></p>
</blockquote>
<p>fscrypt ä¾èµ–å†…æ ¸é…ç½®<code>CONFIG_FS_ENCRYPTION=y</code>ï¼Œè¿™é‡Œæ“ä½œç³»ç»Ÿé€‰æ‹©ä½¿ç”¨ ANCK 5.10 å†…æ ¸çš„ Anolis OSï¼Œå…¶æ¬¡ï¼Œéœ€è¦æ”¯æŒ fscrypt ç‰¹æ€§çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™é‡Œä»¥ ext4 ä¸ºä¾‹ï¼Œå½“ç„¶ï¼ŒF2FS æˆ–è€… UBIFS ä¹Ÿå¯ä»¥ã€‚</p>
<p>ç”¨æˆ·ç©ºé—´æ˜¯é€šè¿‡ fscrypt API è·Ÿå†…æ ¸å®Œæˆäº¤äº’çš„ï¼Œå¯¹äºç”¨æˆ·æ¥è¯´ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡<code>fscryptctl</code>æˆ–è€…<code>fscrypt</code>å·¥å…·æ¥ä¸‹è¾¾åŠ å¯†ç­–ç•¥ã€‚</p>
<p>æœ¬èŠ‚å†…å®¹ä»¥ <strong>fscryptctlï¼ˆ<a href="https://github.com/google/fscryptctl">https://github.com/google/fscryptctl</a>ï¼‰</strong> å·¥å…·ä¸ºä¾‹æ¥æ¼”ç¤ºï¼Œç›®å‰è¿™æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹å·¥å…·ï¼Œéœ€è¦æ‰‹å·¥å®‰è£…ï¼ŒæŒ‰å¦‚ä¸‹å¸¸è§„æµç¨‹å®‰è£…ï¼š</p>
<pre><code class="language-sh">git clone https://github.com/google/fscryptctl.git

cd fscryptctl

make

make install
</code></pre>
<p>å…¶æ¬¡ï¼Œé€‰æ‹©ä¸€å—æœªç”¨åˆ°çš„ç£ç›˜æ ¼å¼åŒ–ä¸ºæ”¯æŒ fscrypt çš„æ–‡ä»¶ç³»ç»Ÿ ext4ï¼Œå¹¶æŒ‚è½½ã€‚</p>
<pre><code class="language-sh">mkfs.ext4 -O encrypt /dev/vda3

mount /dev/vda3 /mnt
</code></pre>
<blockquote>
<p>ğŸŸ¢ <strong>é€æ˜åŠ å¯†æ–‡ä»¶</strong></p>
</blockquote>
<p>fscrypt æ‰€ç”¨çš„åŠ è§£å¯†é’¥æ˜¯å…³è”åœ¨è¶…çº§å—ä¸Šçš„ï¼Œè¿è¡Œæ—¶æ˜¯è·ŸæŒ‚è½½ç‚¹ç›¸å…³è”çš„ï¼Œæ·»åŠ åˆ é™¤å¯†é’¥éƒ½æ˜¯é’ˆå¯¹æŒ‚è½½ç‚¹çš„æ“ä½œï¼Œä»¥ä¸‹å¯¹å¯†é’¥æ“ä½œçš„å‘½ä»¤éƒ½ä¼šå¸¦ä¸ŠæŒ‚è½½ç‚¹ã€‚</p>
<p>æŒ‰å¦‚ä¸‹å‘½ä»¤æ‰€ç¤ºè®¾ç½®åŠ å¯†ç­–ç•¥ï¼š</p>
<pre><code class="language-shell"># ç”Ÿæˆå¯†é’¥æ–‡ä»¶ï¼Œå®é™…ç¯å¢ƒä¸­åº”ç”¨ä½¿ç”¨æ›´å¤æ‚çš„å¯†é’¥
&gt; echo '1234567812345678' &gt; /tmp/keyfile

# æ·»åŠ è¯¥å¯†é’¥åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œè¿”å›å¯†é’¥IDï¼Œä¹‹åå¯¹å¯†é’¥çš„æ“ä½œéƒ½ä½¿ç”¨è¿™ä¸ªIDæ¥ç´¢å¼•
&gt; fscryptctl add_key /mnt &lt; /tmp/keyfile
23086a13ed81fd75ca5fe9b8f2ff25c7

# æŸ¥çœ‹å¯†é’¥çŠ¶æ€ï¼ˆä¸æ˜¯å¿…éœ€ï¼‰
&gt; fscryptctl key_status 23086a13ed81fd75ca5fe9b8f2ff25c7 /mnt
Present (user_count=1, added_by_self)

# åˆ›å»ºåŠ å¯†ç›®å½• endirï¼Œå¹¶è®¾ç½®åŠ å¯†ç­–ç•¥
# ä½¿ç”¨ä¹‹å‰æ·»åŠ çš„å¯†é’¥å’Œ SM4 ç®—æ³•æ¥åŠ å¯†è¯¥ç›®å½•ä¸­çš„æ–‡ä»¶å’Œå­ç›®å½•
&gt; mkdir /mnt/endir
&gt; fscryptctl set_policy --contents=SM4-XTS \
        --filenames=SM4-CTS 23086a13ed81fd75ca5fe9b8f2ff25c7 /mnt/endir

# æŸ¥çœ‹ç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆï¼ˆä¸æ˜¯å¿…éœ€ï¼‰
&gt; fscryptctl get_policy /mnt/endir
Encryption policy for /mnt/endir:
	Policy version: 2
	Master key identifier: 23086a13ed81fd75ca5fe9b8f2ff25c7
	Contents encryption mode: SM4-XTS
	Filenames encryption mode: SM4-CTS
	Flags: PAD_32
</code></pre>
<p>æ­¤æ—¶ï¼Œendir å·²ç»æ˜¯æ”¯æŒé€æ˜åŠ è§£å¯†çš„ä¸€ä¸ªç›®å½•ï¼Œå¯ä»¥åƒæ­£å¸¸ç›®å½•ä¸€æ ·åˆ›å»ºåˆ é™¤æ–‡ä»¶ï¼Œåœ¨è¯¥ç›®å½•ä¸‹è¿›è¡Œä¸€äº›å¸¸è§„çš„æ–‡ä»¶æ“ä½œï¼Œå¯ä»¥çœ‹åˆ°ä¸æ™®é€šç›®å½•æ²¡æœ‰åŒºåˆ«ï¼š</p>
<pre><code class="language-shell">&gt; mkdir /mnt/endir/foo
&gt; echo 'hello' &gt; /mnt/endir/foo/hello

&gt; cp -v /usr/include/curl/* endir
&gt; tree /mnt/endir
/mnt/endir
â”œâ”€â”€ curl.h
â”œâ”€â”€ easy.h
â”œâ”€â”€ foo
â”‚Â Â  â””â”€â”€ hello
â””â”€â”€ websockets.h
</code></pre>
<blockquote>
<p>ğŸŸ¢ <strong>é”å®šåŠ å¯†ç›®å½•</strong></p>
</blockquote>
<p>ä¹‹æ‰€ä»¥èƒ½åƒæ™®é€šç›®å½•ä¸€æ ·æ“ä½œï¼Œæ˜¯å› ä¸ºå¯†é’¥å·²ç»è¢«æ·»åŠ åˆ°äº†æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚æ¥ä¸‹æ¥åˆ é™¤å¯†é’¥åï¼Œå°±èƒ½çœ‹åˆ°ç›®å½•è¢«é”å®šï¼Œé‡Œé¢çš„æ‰€æœ‰è·¯å¾„å’Œå†…å®¹éƒ½æ˜¯åŠ å¯†çŠ¶æ€ï¼š</p>
<pre><code class="language-shell"># ç§»é™¤å¯†é’¥
&gt; fscryptctl remove_key 23086a13ed81fd75ca5fe9b8f2ff25c7 /mnt

&gt; fscryptctl key_status 23086a13ed81fd75ca5fe9b8f2ff25c7 /mnt
Absent

# å¤„äºåŠ å¯†çŠ¶æ€çš„ç›®å½•æ ‘
&gt; tree /mnt/endir
/mnt/endir
â”œâ”€â”€ 1H2e0BbS4MGZKAKEu6NVXniaYMWIrWDwbyzX6EVEWEN8tfWcWNgDyw
â”œâ”€â”€ LvYw6Jl0a1jImKKOFPjtpG3hEDxjjuM6YIYqcMeXaWdzKUdaX0YCNQ
â”œâ”€â”€ QBBz8_qGE4MJY6YVzfqVUkr6YeCSqtoQmbvG04BsR0lAr2oLwO0b2g
â”‚Â Â  â””â”€â”€ wOYdFlMRACjeBa-eSo3LuO4sE55q1YuFv-S_lVU-n498jdMjAt06JA
â””â”€â”€ zoiobWxVG2DLjg8uMXfsVP11159zqQUjozJ8gmt1zyjayJlZ4awOhA

# ç›®å½•è¢«é”å®šï¼Œæ— æ³•è¿›è¡Œå¸¸è§„æ–‡ä»¶æ“ä½œï¼Œå³ä¾¿æ‹”ç›˜ï¼Œä¹Ÿä¸èƒ½å¾—åˆ°æ˜æ–‡å†…å®¹
&gt; cat /mnt/endir/1H2e0BbS4MGZKAKEu6NVXniaYMWIrWDwbyzX6EVEWEN8tfWcWNgDyw
cat: /mnt/endir/1H2e0BbS4MGZKAKEu6NVXniaYMWIrWDwbyzX6EVEWEN8tfWcWNgDyw: Required key not available
&gt; mkdir /mnt/endir/hello
mkdir: cannot create directory â€˜/mnt/endir/helloâ€™: Required key not available
</code></pre>
<blockquote>
<p>ğŸŸ¢ <strong>å†æ¬¡è§£é”åŠ å¯†ç›®å½•</strong></p>
</blockquote>
<p>è¦è§£é”ç›®å½•ä¹Ÿå¾ˆç®€å•ï¼Œé‡æ–°æ·»åŠ å¯†é’¥å³å¯ï¼Œæ–‡ä»¶ç³»ç»Ÿä¼šæœç´¢åˆ°æ­£ç¡®çš„å¯†é’¥å¹¶è§£é”ç›¸åº”ç›®å½•ï¼š</p>
<pre><code class="language-shell">&gt; fscryptctl add_key /mnt &lt; /tmp/keyfile
23086a13ed81fd75ca5fe9b8f2ff25c7

# æ·»åŠ å¯†é’¥åæ–‡ä»¶å†…å®¹å¯æ­£å¸¸è®¿é—®
&gt; cat /mnt/endir/foo/hello
hello
</code></pre>
<h2 id="åè®°"><a class="header" href="#åè®°">åè®°</a></h2>
<p>fscryptctl æ˜¯ä¸€ä¸ªç›¸å¯¹åŸç”Ÿçš„å·¥å…·ï¼Œæ›´æ¥è¿‘å†…æ ¸ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¯¥å·¥å…·å‘½ä»¤æ¯”è¾ƒå¤æ‚ï¼Œä½¿ç”¨ä¸­éœ€è¦è®°ä½å¾ˆé•¿ä¸€ä¸²å¯†é’¥IDï¼Œç”¨æˆ·ä½“éªŒå¹¶ä¸å¥½ã€‚</p>
<p>å®é™…ç¯å¢ƒä¸­ï¼Œä¸€èˆ¬ä¼šä½¿ç”¨ <strong><a href="https://github.com/google/fscrypt">fscrypt</a></strong> å·¥å…·æ¥å®ŒæˆåŠ å¯†ç­–ç•¥æ“ä½œï¼Œè¯¥å·¥å…·ç”± Google å¼€å‘ï¼Œç”¨Goè¯­è¨€å†™æˆï¼Œé€šè¿‡åœ¨ç”¨æˆ·å±‚é¢ç»´æŠ¤äº†ä¸€äº›å…ƒæ•°æ®æ¥ç®€åŒ–ç”¨æˆ·æ“ä½œï¼Œå‘½ä»¤æ›´æ˜“äºç†è§£ï¼Œä¹Ÿæ›´æ¥è¿‘ç”¨æˆ·ã€‚</p>
<footer>
<span class="copyright">Copyright Â© openanolis.cn 2023 all right reserved</span>
<pre><code class="footer-code">ä½œè€…: OpenAnolis
é“¾æ¥: https://github.com/openanolis/whitebook-shangmi
æ¥æº: OpenAnolis
æœ¬æ–‡åŸåˆ›å‘å¸ƒäºã€ŒOpenAnolisã€,è½¬è½½è¯·æ³¨æ˜å‡ºå¤„,è°¢è°¢åˆä½œ!
</code></pre>
</footer>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="kernel_shangmi.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="kernel_dmcrypt.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="kernel_shangmi.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="kernel_dmcrypt.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
