<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>å†…æ ¸å®Œæ•´æ€§åº¦é‡æ¶æ„ï¼ˆIMAï¼‰ - å•†ç”¨å¯†ç æŠ€æœ¯æœ€ä½³å®è·µç™½çš®ä¹¦</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="overview.html">å‰è¨€</a></li><li class="chapter-item "><a href="openanolis.html">OpenAnolis é¾™èœ¥ç¤¾åŒº</a></li><li class="chapter-item "><a href="introduction.html">å›½å¯†ç®€ä»‹ä¸ç°çŠ¶</a></li><li class="chapter-item "><a href="shangmi_sig.html">OpenAnolis å…¨æ ˆå›½å¯†æ¦‚è¿°</a></li><li class="chapter-item "><a href="anolisos_guide.html">Anolis OS å›½å¯†å¼€å‘æŒ‡å—</a></li><li class="chapter-item "><a href="trusted_computing.html">å›½å¯†å¯ä¿¡è®¡ç®—</a></li><li class="chapter-item "><a href="secure_boot.html">å›½å¯†å®‰å…¨å¯åŠ¨</a></li><li class="chapter-item expanded "><a href="linux_kernel.html">Linux å†…æ ¸å›½å¯†æ”¯æŒ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="kernel_shangmi.html">å†…æ ¸å›½å¯†ç®—æ³•</a></li><li class="chapter-item "><a href="kernel_fscrypt.html">æ–‡ä»¶åŠ å¯†ï¼ˆfscryptï¼‰</a></li><li class="chapter-item "><a href="kernel_dmcrypt.html">ç£ç›˜åŠ å¯†ï¼ˆLUKSï¼‰</a></li><li class="chapter-item expanded "><a href="kernel_ima.html" class="active">å†…æ ¸å®Œæ•´æ€§åº¦é‡æ¶æ„ï¼ˆIMAï¼‰</a></li><li class="chapter-item "><a href="kernel_modsign.html">å†…æ ¸æ¨¡å—ç­¾å</a></li><li class="chapter-item "><a href="kernel_tls.html">Kernel TLSï¼ˆKTLSï¼‰å®è·µ</a></li></ol></li><li class="chapter-item "><a href="tongsuo.html">Tongsuoï¼ˆé“œé”ï¼‰å¯†ç åº“</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="tongsuo_tls.html">TLS 1.3 ä½¿ç”¨å•†å¯†å¥—ä»¶</a></li><li class="chapter-item "><a href="tongsuo_dc.html">å§”æ‰˜å‡­è¯</a></li><li class="chapter-item "><a href="tongsuo_cc.html">è¯ä¹¦å‹ç¼©ï¼ˆRFC 8879ï¼‰</a></li><li class="chapter-item "><a href="tongsuo_tlcp.html">TLCP å®‰å…¨ä¼ è¾“åè®®</a></li><li class="chapter-item "><a href="tongsuo_he.html">åŒæ€ç®—æ³•</a></li><li class="chapter-item "><a href="tongsuo_java_sdk.html">Tongsuo-Java-SDK</a></li></ol></li><li class="chapter-item "><a href="crypto_library.html">OpenAnolis å›½å¯†ç®—æ³•åº“</a></li><li class="chapter-item "><a href="dev_practices.html">å›½å¯†åº”ç”¨å¼€å‘å®è·µ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="python_shangmi.html">Python å›½å¯†ç­¾åå®è·µ</a></li><li class="chapter-item "><a href="nginx_tlcp.html">Web æœåŠ¡å›½å¯†åŒè¯ä¹¦æ”¯æŒ</a></li></ol></li><li class="chapter-item "><a href="optimization.html">å›½å¯†ç¡¬ä»¶åŠ é€Ÿä¸ä¼˜åŒ–</a></li><li class="chapter-item affix "><a href="contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">å•†ç”¨å¯†ç æŠ€æœ¯æœ€ä½³å®è·µç™½çš®ä¹¦</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="å†…æ ¸å®Œæ•´æ€§åº¦é‡æ¶æ„ima"><a class="header" href="#å†…æ ¸å®Œæ•´æ€§åº¦é‡æ¶æ„ima">å†…æ ¸å®Œæ•´æ€§åº¦é‡æ¶æ„ï¼ˆIMAï¼‰</a></h1>
<h2 id="ima-ç®€ä»‹"><a class="header" href="#ima-ç®€ä»‹">IMA ç®€ä»‹</a></h2>
<p>IMAæ˜¯<code>Integrity Measurement Architecture</code>çš„ç¼©å†™ï¼Œå®ƒæ˜¯Linuxå†…æ ¸ä¸­å®Œæ•´æ€§å­ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚ç›®å‰Linuxå†…æ ¸çš„å®Œæ•´æ€§å­ç³»ç»Ÿæ”¯æŒEVMå’ŒIMAï¼Œå‰è€…ç”¨äºä¿æŠ¤æ–‡ä»¶çš„æ‰©å±•å±æ€§ã€‚æœ¬å°èŠ‚è®¨è®ºçš„æ˜¯åè€…ã€‚</p>
<p>IMAæ‰€èƒ½åšåˆ°çš„äº‹æƒ…åŒ…æ‹¬ï¼š</p>
<ul>
<li>èƒ½å¤Ÿå¯¹æ­£åœ¨æ‰“å¼€çš„æ–‡ä»¶è¿›è¡Œå®Œæ•´æ€§è¯„ä¼°ã€‚</li>
<li>èƒ½å¤Ÿå¯¹æ­£åœ¨æ‰§è¡Œexecçš„æ–‡ä»¶ï¼ˆå¯æ‰§è¡Œç¨‹åºï¼‰è¿›è¡Œå®Œæ•´æ€§è¯„ä¼°ã€‚</li>
<li>èƒ½å¤Ÿå¯¹æ­£åœ¨æ‰§è¡Œmmap(PROT_EXEC)çš„æ–‡ä»¶ï¼ˆå…±äº«åº“ï¼‰è¿›è¡Œå®Œæ•´æ€§è¯„ä¼°ã€‚</li>
<li>èƒ½å¤Ÿå¯¹æ­£åœ¨åŠ è½½ä¸­çš„kernelæ¨¡å—å’Œå›ºä»¶è¿›è¡Œå®Œæ•´æ€§è¯„ä¼°ã€‚</li>
</ul>
<p>æ‰€è°“çš„å®Œæ•´æ€§è¯„ä¼°æŒ‡çš„æ˜¯å¯¹å†…æ ¸å¯¹æ–‡ä»¶å®¢ä½“åœ¨æ‰§è¡Œç‰¹å®šçš„å†…æ ¸æ“ä½œæ—¶ï¼Œä¼šä¸»åŠ¨å¯¹æ–‡ä»¶çš„å†…å®¹è¿›è¡Œå®Œæ•´æ€§æ£€æŸ¥ã€‚ä¸ºæ­¤ï¼ŒIMAå­ç³»ç»Ÿä¼šå€Ÿç”¨å†…æ ¸çš„securityå­ç³»ç»Ÿåœ¨open(), execve(), mmap()ç­‰ç³»ç»Ÿè°ƒç”¨ä¸­ä¸‹çš„hookæ¥æ‰§è¡Œè‡ªå·±çš„ä»£ç ã€‚</p>
<h2 id="ima-åŸç†"><a class="header" href="#ima-åŸç†">IMA åŸç†</a></h2>
<p>IMAåœ¨è¿›è¡Œå®Œæ•´æ€§éªŒè¯æ—¶ï¼Œä¼šé€šè¿‡äº‹å…ˆå­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æ‰©å±•å±æ€§security.imaè¿›è¡Œã€‚å…·ä½“æ¥è¯´ï¼Œå€Ÿç”¨IMAç­¾åå·¥å…·evmctlï¼Œåœ¨ç³»ç»Ÿéƒ¨ç½²çš„æ—¶å€™ï¼Œç®¡ç†å‘˜ä»¥ç‰¹æƒç”¨æˆ·èº«ä»½å°†æ–‡ä»¶çš„å®Œæ•´æ€§ä¿¡æ¯å†™å…¥æ–‡ä»¶æ‰©å±•å±æ€§security.imaä¸­ã€‚</p>
<p>åœ¨ç³»ç»Ÿè¿è¡Œæ—¶ï¼ŒIMAå­ç³»ç»Ÿä¼šä»è¯¥æ‰©å±•å±æ€§ä¸­è¯»å–å‡ºæ–‡ä»¶çš„å®Œæ•´æ€§ä¿¡æ¯ï¼ŒåŒæ—¶ä¸å®é™…è®¡ç®—å‡ºçš„å®Œæ•´æ€§ä¿¡æ¯è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœç»“æœä¸€è‡´ï¼Œè¯æ˜è¯¥æ–‡ä»¶æ²¡æœ‰é­åˆ°è¿‡ç¯¡æ”¹ï¼Œåˆ™å…è®¸æ‰§è¡Œåç»­çš„æ“ä½œï¼›å¦‚æœç»“æœä¸ä¸€è‡´ï¼Œè¯æ˜æ–‡ä»¶å†…å®¹é­åˆ°äº†ç¯¡æ”¹ï¼Œåˆ™åç»­æ“ä½œç¦æ­¢æ‰§è¡Œã€‚</p>
<p>å› æ­¤ï¼Œå³ä½¿æ”»å‡»è€…é€šè¿‡å¯†ç ç ´è§£æ‹¿åˆ°äº†æœ¬åœ°ç‰¹æƒï¼Œæˆ–è€…åˆ©ç”¨å®‰å…¨æ¼æ´æ‹¿åˆ°äº†æœ¬åœ°ç‰¹æƒï¼Œä½†æ˜¯åœ¨å‡†å¤‡è¿è¡Œæ¶æ„ç¨‹åºæˆ–æ¤å…¥äº†åé—¨çš„ç¨‹åºçš„æ—¶å€™ï¼Œå› ä¸ºåœ¨æ²¡æœ‰IMAç§é’¥çš„æƒ…å†µä¸‹æ˜¯æ— æ³•æ„é€ å‡ºåˆæ³•çš„IMAç­¾åçš„ï¼Œå› æ­¤å¯¼è‡´æ¶æ„ç¨‹åºæˆ–è¢«ç¯¡æ”¹äº†çš„ç¨‹åºå‡æ— æ³•è¿è¡Œã€‚å³ä½¿å¸¦æœ‰IMAä¿æŠ¤çš„å­˜å‚¨è®¾å¤‡å—åˆ°ç¦»çº¿æ”»å‡»ï¼ˆæ¯”å¦‚æŠŠå­˜å‚¨è®¾å¤‡ä»ä¸»æœºä¸Šå–ä¸‹ï¼Œæ‹¿åˆ°å¦ä¸€å°æœºå™¨ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œç„¶åå†é‡æ–°å®‰è£…åˆ°ä¸»æœºä¸Šï¼‰ï¼Œè¢«ç¯¡æ”¹çš„æ–‡ä»¶æˆ–æ”»å‡»è€…æ¤å…¥çš„æ¶æ„è½¯ä»¶åœ¨è¿è¡Œæ—¶ä¾æ—§æ— æ³•è¿è¡Œï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šèƒ½å¤ŸæŠ‘åˆ¶ç±»ä¼¼Dirty Cowè¿™æ ·çš„å†…æ ¸æ¼æ´æ‰€å¸¦æ¥çš„å±å®³ã€‚</p>
<h2 id="ima-å•†å¯†åŒ–å®è·µ"><a class="header" href="#ima-å•†å¯†åŒ–å®è·µ">IMA å•†å¯†åŒ–å®è·µ</a></h2>
<p>æ‰€è°“IMAå•†å¯†åŒ–ï¼Œå°±æ˜¯åœ¨IMAæ•´ä¸ªç­¾åéªŒè¯æµç¨‹ä¸­ï¼Œä½¿ç”¨å•†å¯†ç®—æ³•SM3ä»£æ›¿å›½é™…å¸¸ç”¨çš„å“ˆå¸Œç®—æ³•SHA256ï¼ŒSHA512ç­‰ï¼Œç”¨SM2ç®—æ³•çš„ç­¾åéªŒç­¾å–ä»£RSAç®—æ³•ã€‚</p>
<p>æœ¬æ–‡ä¸­ç”¨åˆ°çš„ä¸»è¦æ˜¯ä»¥ä¸‹å…¬å¼€çš„å•†å¯†ç®—æ³•ï¼š</p>
<ul>
<li>SM2ï¼šåŸºäºæ¤­åœ†æ›²çº¿å¯†ç ï¼ˆECCï¼‰çš„å…¬é’¥å¯†ç ç®—æ³•æ ‡å‡†ï¼Œæä¾›æ•°å­—ç­¾åï¼Œå¯†é’¥äº¤æ¢ï¼Œå…¬é’¥åŠ å¯†ï¼Œç”¨äºæ›¿æ¢RSA/ECDSA/ECDHç­‰å›½é™…ç®—æ³•</li>
<li>SM3ï¼šæ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼Œå“ˆå¸Œç»“æœä¸º256 bitsï¼Œç”¨äºæ›¿æ¢MD5/SHA1/SHA256ç­‰å›½é™…ç®—æ³•</li>
</ul>
<p>é¦–å…ˆï¼Œå®‰è£…å®è·µIMAå¿…è¦çš„å·¥å…·åŒ…ï¼š</p>
<pre><code class="language-sh">yum install -y keyutils ima-evm-utils
</code></pre>
<blockquote>
<p>ğŸŸ¢ <strong>ç”Ÿæˆå•†å¯†å¯†é’¥å’Œè¯ä¹¦</strong></p>
</blockquote>
<p>ä¸ºäº†ä½¿ç”¨IMAåŠŸèƒ½ï¼Œå…ˆè¦å‡†å¤‡ä»¥ä¸‹å¯†é’¥å’Œè¯ä¹¦ï¼š</p>
<ul>
<li>CAæ ¹è¯ä¹¦ï¼šä¸ºäº†ä¾¿äºå®éªŒï¼Œè¿™é‡Œé€‰æ‹©è‡ªç­¾åçš„è¯ä¹¦ï¼Œä½œä¸ºä¿¡ä»»æ ¹å†…ç½®åˆ°å†…æ ¸é‡Œ</li>
<li>IMAç§é’¥ï¼šä¸IMAè¯ä¹¦å¯¹åº”çš„SM2ç§é’¥ï¼Œç”¨äºç­¾åæ–‡ä»¶</li>
<li>IMAè¯ä¹¦ï¼šç”±CAæ ¹è¯ä¹¦ç­¾åï¼Œç³»ç»Ÿå¯åŠ¨ååŠ¨æ€å¯¼å…¥å†…æ ¸</li>
</ul>
<pre><code class="language-sh"># åˆ›å»ºç­¾åè¯ä¹¦è¯·æ±‚ä½¿ç”¨çš„é…ç½®æ–‡ä»¶genkey.conf
cat &gt; genkey.conf &lt;&lt; EOF
[ req ]
distinguished_name = req_distinguished_name
prompt = no
string_mask = utf8only
x509_extensions = v3_ca

[ req_distinguished_name ]
O = IMA-test
CN = IMA test key
emailAddress = ima@test.com

[ v3_ca ]
basicConstraints=critical,CA:FALSE
keyUsage=digitalSignature
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid:always
EOF

# ç”Ÿæˆä¸€ä¸ªè‡ªç­¾åçš„æ ¹è¯ä¹¦ca.certï¼Œä½œä¸ºCAè¯ä¹¦
openssl ecparam -genkey -name SM2 -text -out ca.key
openssl req -verbose -new -days 10000 -x509 \
    -sm3 -sigopt &quot;distid:1234567812345678&quot; \
    -config genkey.conf -key ca.key -out ca.cert

# ç”ŸæˆSM2ç§é’¥sm2.key
openssl ecparam -genkey -name SM2 -text -out sm2.key

# ä»ç§é’¥ç”Ÿæˆè¯ä¹¦è¯·æ±‚
openssl req -verbose -new \
    -sm3 -sigopt &quot;distid:1234567812345678&quot; \
    -config genkey.conf -key sm2.key -out sm2.csr

# ä½¿ç”¨CAè¯ä¹¦ç»™SM2è¯ä¹¦è¯·æ±‚ç­¾åï¼Œç”ŸæˆIMAè¦ä½¿ç”¨çš„å•†å¯†è¯ä¹¦sm2.cert
openssl x509 -req -days 10000 -sm3 \
    -sigopt &quot;distid:1234567812345678&quot; \
    -vfyopt &quot;distid:1234567812345678&quot; \
    -CA ca.cert -CAkey ca.key -CAcreateserial \
    -extfile genkey.conf -extensions v3_ca \
    -in sm2.csr -out sm2.cert
</code></pre>
<blockquote>
<p>ğŸŸ¢ <strong>ç¼–è¯‘å¹¶å®‰è£…æ–°å†…æ ¸</strong></p>
</blockquote>
<p>ä¸ºäº†æµ‹è¯•å’ŒéªŒè¯IMAç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦æŠŠCAæ ¹è¯ä¹¦å†…ç½®åˆ°å†…æ ¸ï¼Œè¿™éœ€è¦ä½¿ç”¨æ–°çš„CAæ ¹è¯ä¹¦é‡æ–°ç¼–è¯‘å†…æ ¸ã€‚</p>
<p>æŒ‰å¦‚ä¸‹æ­¥éª¤ä¾æ¬¡ä¸‹è½½å†…æ ¸æºä»£ç ï¼Œç¼–è¯‘ï¼Œå®‰è£…å†…æ ¸åå¹¶é‡å¯ç³»ç»Ÿï¼š</p>
<pre><code class="language-sh"># ä¸‹è½½Anolis OSçš„ANCKæºä»£ç ï¼Œä½¿ç”¨æœ€æ–°çš„5.10åˆ†æ”¯å³å¯
git clone https://gitee.com/anolis/cloud-kernel.git -b devel-5.10

# å®‰è£…ç¼–è¯‘ä¾èµ–
yum install -y bison flex elfutils-libelf-devel bc make gcc

# ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆå¥½çš„ca.certä½œä¸ºå†…æ ¸ä¿¡ä»»çš„æ ¹è¯ä¹¦ï¼Œä½¿ç”¨é»˜è®¤é…ç½®ç¼–è¯‘å†…æ ¸
cp -f ca.cert &lt;kernel_src&gt;/certs/

# è¿›å…¥å†…æ ¸æºç ç›®å½•ï¼Œä½¿ç”¨é»˜è®¤é…ç½®ç¼–è¯‘å†…æ ¸
cd &lt;kernel_src&gt;

# å¦‚æœæ‚¨æ˜¯armçš„é•œåƒï¼Œè¯·å°† arch/arm64/configs/anolis_defconfig ä½œä¸º.configï¼›
# å¦‚æœæ˜¯x86çš„ï¼Œè¯·å°† arch/x86/configs/anolis_defconfig ä½œä¸º.configã€‚ä»¥x86ä¸ºä¾‹
cp -f arch/x86/configs/anolis_defconfig .config

# é…ç½®ç³»ç»Ÿçš„å¯ä¿¡æ ¹è¯ä¹¦
sed -i 's/CONFIG_SYSTEM_TRUSTED_KEYS=\&quot;\&quot;/CONFIG_SYSTEM_TRUSTED_KEYS=\&quot;certs\/ca.cert\&quot;/' .config

# ç¼–è¯‘
make -j&lt;nproc&gt;

# å®‰è£…modules
make modules_install

# å®‰è£…å†…æ ¸ï¼Œè¿™ä¸€æ­¥ä¹Ÿä¼šè‡ªåŠ¨ç”Ÿæˆinitramfså¹¶æ›´æ–°grub.cfg
make install

# æŸ¥çœ‹vmlinuz
ls -l /boot/vmlinuz*

# å°†æ–°å†…æ ¸è®¾ç½®ä¸ºç¼ºçœçš„å¯åŠ¨å†…æ ¸ï¼Œè¿™é‡Œæ ¹æ®å®é™…æƒ…å†µè‡ªè¡Œè°ƒæ•´
grubby --set-default /boot/vmlinuz-5.10.&lt;minor version&gt;

# é‡å¯
reboot
</code></pre>
<p>é‡å¯æœºå™¨åï¼Œé€šè¿‡<code>/proc/keys</code>æˆ–è€…<code>keyctl</code>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„SM2æ ¹è¯ä¹¦å·²ç»å†…ç½®åˆ°äº†å†…æ ¸ä¸­ï¼š</p>
<pre><code class="language-shell"># cat /proc/keys | grep sm2
02a32516 I------ 1 perm 1f030000 0 0 asymmetri: IMA-test: bc08a9e6e43c...: X509.sm2 3a089aca []

# keyctl show %:.secondary_trusted_keys
Keyring
 371108982 ---lswrv 0 0 keyring: .secondary_trusted_keys
 945861859 ---lswrv 0 0  \_ keyring: .builtin_trusted_keys
 575535217 ---lswrv 0 0      \_ asymmetric: Build time autogenerated kernel key: 60d20efc1951...
  44246294 ---lswrv 0 0      \_ asymmetric: IMA-test: bc08a9e6e43c...
</code></pre>
<blockquote>
<p>ğŸŸ¢ <strong>å¯¼å…¥IMAè¯ä¹¦åˆ°å†…æ ¸</strong></p>
</blockquote>
<p>ä¸ºäº†ä½¿ç”¨IMAåŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå‰é¢ç”¨CAè¯ä¹¦ç­¾åçš„IMAè¯ä¹¦sm2.certå¯¼å…¥åˆ°å†…æ ¸ï¼Œä¹‹åæ‰èƒ½ç”¨è¯¥è¯ä¹¦æ­£ç¡®éªŒç­¾IMAç§é’¥ç­¾åçš„æ–‡ä»¶ï¼Œå› ä¸ºå†…æ ¸å·²ç»é›†æˆäº†CAæ ¹è¯ä¹¦ï¼Œä¹Ÿåªæœ‰CAç­¾åçš„è¯ä¹¦æ‰èƒ½æˆåŠŸå¯¼å…¥å†…æ ¸ã€‚</p>
<p>å†…æ ¸åªæ”¯æŒå¯¼å…¥DERæ ¼å¼çš„è¯ä¹¦ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆå°†pemçš„è¯ä¹¦è½¬æ¢ä¸ºderæ ¼å¼ï¼Œå‘½ä»¤å¦‚ä¸‹</p>
<pre><code class="language-sh"># å†…æ ¸åªæ”¯æŒå¯¼å…¥DERæ ¼å¼çš„è¯ä¹¦
openssl x509 -in sm2.cert -outform der -out sm2.cert.der
</code></pre>
<p>ç”¨keyctlå¯¼å…¥è¯ä¹¦ï¼Œæ³¨æ„<strong>ç³»ç»Ÿé‡å¯åä¼šå¤±æ•ˆ</strong></p>
<pre><code class="language-sh"># éæŒä¹…æ€§å¯¼å…¥, é‡å¯åå¤±æ•ˆ
keyctl padd asymmetric &quot;IMA&quot; %:.ima &lt; sm2.cert.der
</code></pre>
<p>IMAè¯ä¹¦å¯¼å…¥æˆåŠŸåï¼Œæˆ‘ä»¬å¯ä»¥ä»<code>/proc/keys</code>çœ‹åˆ°è¯ä¹¦ä¿¡æ¯</p>
<pre><code class="language-sh"># IMAè¯ä¹¦å¯¼å…¥æˆåŠŸåï¼Œæˆ‘ä»¬å¯ä»¥ä»/proc/keysçœ‹åˆ°è¯ä¹¦ä¿¡æ¯ï¼š
cat /proc/keys | grep sm2
03cd0857 I------ 1 perm 1f030000 0 0 asymmetri: IMA-test: 10024aa19b7b...: X509.sm2 806f9ca2 []
069ced19 I--Q--- 1 perm 39010000 0 0 asymmetri IMA: X509.sm2 604c5d8c []
</code></pre>
<blockquote>
<p>ğŸŸ¢ <strong>IMAç­¾å</strong></p>
</blockquote>
<p>æ¥ä¸‹æ¥ç»™ç³»ç»Ÿä¸­éœ€è¦IMAéªŒè¯çš„æ–‡ä»¶åŠ ä¸ŠSM2çš„ç­¾åï¼Œè¿™é‡Œç®€å•ç²—æš´çš„ç»™å¸¸ç”¨ç›®å½•ä¸‹æ–‡ä»¶å…¨éƒ¨ç­¾åï¼Œå¦‚æœæ–‡ä»¶æ¯”è¾ƒå¤šçš„è¯ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæŒç»­å‡ åˆ†é’Ÿã€‚</p>
<pre><code class="language-sh"># ä½¿ç”¨SM3å“ˆå¸Œç®—æ³•ï¼Œsm2.keyæ˜¯ç­¾åç”¨çš„ç§é’¥ï¼Œç»™ç³»ç»Ÿä¸»è¦ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶åšIMAç­¾å
for dir in bin sbin usr lib lib64 etc home; do
    evmctl ima_sign -a sm3 -s -k /path/to/sm2.key -r -t f /$dir
done

# é€šè¿‡getfattrå¯ä»¥æŸ¥çœ‹æ·»åŠ åˆ°æ–‡ä»¶æ‰©å±•å±æ€§ä¸­çš„ç­¾åæ•°æ®ï¼ˆä¸æ˜¯å¿…éœ€ï¼‰
yum install -y attr
getfattr -n security.ima /path/to/file
</code></pre>
<blockquote>
<p>ğŸŸ¢ <strong>å¯¼å…¥IMAç­–ç•¥</strong></p>
</blockquote>
<p>IMAç­–ç•¥æ˜¯ä½¿èƒ½IMAçš„å¿…å¤‡æ­¥éª¤ï¼Œç­–ç•¥çš„å†…å®¹å¯ä»¥æ ¹æ®å®é™…éœ€è¦è¿›è¡Œå®šåˆ¶ã€‚ä¸ºäº†æ–¹ä¾¿è¯´æ˜é—®é¢˜ï¼Œè¿™é‡Œä»¥ç”¨æˆ·imatestæ¥æµ‹è¯•ï¼Œåœ¨ä¸‹é¢çš„è§„åˆ™ç¤ºä¾‹ä¸­ï¼Œå½“ä»¥imatestèº«ä»½è¿è¡Œå¯æ‰§è¡Œç¨‹åºå’Œå…±äº«åº“æ—¶ï¼Œä¼šè¿›è¡ŒIMAåº¦é‡ä»¥åŠappraseæ£€æŸ¥ã€‚</p>
<pre><code class="language-sh"># åˆ›å»ºç”¨æˆ·imatest
useradd imatest

# ç”¨æˆ·IDå¯ä»¥ä»/etc/passwdä¸­çœ‹åˆ°ï¼Œè¿™é‡Œæ˜¯1001ï¼Œç”¨æˆ·IDä¼šåœ¨IMAè§„åˆ™ä¸­ç”¨åˆ°
tail /etc/passwd | grep imatest
# imatest:x:1001:1001::/home/imatest:/bin/bash
</code></pre>
<p>å°†ä¸‹é¢çš„æ–‡ä»¶å†…å®¹å¦å­˜ä¸º<code>ima.policy</code>æ–‡ä»¶ï¼š</p>
<pre><code>appraise appraise_type=imasig uid=1001 func=BPRM_CHECK
measure uid=1001 func=BPRM_CHECK
appraise appraise_type=imasig uid=1001 func=MMAP_CHECK
measure uid=1001 func=MMAP_CHECK
</code></pre>
<p>ä¸Šé¢çš„è§„åˆ™è¡¨ç¤ºï¼š</p>
<ul>
<li>åº¦é‡ä»¥uid=1001èº«ä»½è¿è¡Œçš„ç¨‹åºå’Œå…±äº«åº“ï¼Œå¹¶å°†åº¦é‡å€¼è®°å½•åœ¨/sys/kernel/security/ima/ascii_runtime_measurementsæ–‡ä»¶ä¸­ã€‚</li>
<li>è¯„ä¼°ä»¥uid=1001èº«ä»½è¿è¡Œçš„ç¨‹åºå’Œå…±äº«åº“ï¼Œå¦‚æœç¨‹åºçš„å®Œæ•´æ€§è¢«ç ´åï¼Œç¨‹åºå°†è¢«æ‹’ç»è¿è¡Œã€‚</li>
</ul>
<p>ç„¶åå†™å…¥IMAè§„åˆ™åˆ°å†…æ ¸ï¼š</p>
<pre><code class="language-sh">cat ima.policy &gt; /sys/kernel/security/ima/policy
</code></pre>
<blockquote>
<p>ğŸŸ¢ <strong>IMAéªŒè¯</strong></p>
</blockquote>
<p>IMAç­–ç•¥å†™å…¥å†…æ ¸åï¼ŒIMAç‰¹æ€§å°±å·²ç»åœ¨å†…æ ¸ç”Ÿæ•ˆäº†ï¼Œæ­¤æ—¶å¯ä»¥ä»¥imatestç”¨æˆ·èº«ä»½æ‰§è¡Œä¸€äº›æ“ä½œ</p>
<pre><code class="language-sh">su imatest

... ...
</code></pre>
<p>é€šè¿‡<code>ascii_runtime_measurements</code>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°IMAè¿è¡Œæ—¶åº¦é‡çš„ä¿¡æ¯ï¼Œè¿™äº›éƒ½æ˜¯é€šè¿‡IMAéªŒè¯çš„æ–‡ä»¶ï¼Œä»¥ä¸‹æ˜¯éƒ¨åˆ†åº¦é‡æ—¥å¿—ï¼š</p>
<pre><code class="language-shell"># cat /sys/kernel/security/ima/ascii_runtime_measurements
10 bcb0e518b79d... ima-sig sha1:00000000000... boot_aggregate
10 d20bcf8ea6f3... ima-sig sm3:66acf6555ad2... /usr/bin/bash
10 b829e4761f7a... ima-sig sm3:1bcd4a4cb2a2... /usr/lib64/ld-2.17.so
10 be220df2bc61... ima-sig sm3:66acf6555ad2... /usr/bin/bash
10 d262c29452b0... ima-sig sm3:1bcd4a4cb2a2... /usr/lib64/ld-2.17.so
10 26bf0fc75828... ima-sig sm3:18781f4c9104... /usr/lib64/libtinfo.so.5.9
... ...
</code></pre>
<p>æ³¨æ„å…¶ä¸­ç¬¬ä¸€æ¡æ—¥å¿—ï¼Œboot_aggregateæ˜¯ç³»ç»Ÿå¯åŠ¨é˜¶æ®µTPM PCRçš„æ±‡èšå€¼ï¼Œè¿™ä¸ªå€¼æ˜¯æ±‡èšTPMè®¾å¤‡å¯¹åº”PCR bankçš„å€¼åšä¸€ä¸ªdigestï¼Œæ‰€ä½¿ç”¨çš„æ‘˜è¦ç®—æ³•æ˜¯æ ¹æ®TPMè®¾å¤‡ç‰ˆæœ¬ä»¥åŠæ”¯æŒçš„PCR bankå†³å®šï¼Œé»˜è®¤æ˜¯SHA1ï¼Œå½“ç„¶è¿™ä¸ªæ‘˜è¦ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®ä¸ºé»˜è®¤ä¼˜å…ˆSM3ç®—æ³•ï¼Œä¾‹å­ä¸­æ²¡æœ‰TPMè®¾å¤‡ï¼Œæ‰€ä»¥è¿™é‡Œå€¼æ˜¯0ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ„é€ ä¸€ä¸ªæ²¡æœ‰ç»è¿‡ç­¾åçš„å¯æ‰§è¡Œæ–‡ä»¶å¹¶æ‰§è¡Œï¼š</p>
<pre><code class="language-sh">su imatest
cd ~

echo 'int main(){}' &gt; dummy.c
gcc -o dummy dummy.c
</code></pre>
<p>è¿è¡Œdummyå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæç¤ºæ²¡æœ‰æƒé™ï¼Œè¿™æ˜¯ç¬¦åˆé¢„æœŸçš„ï¼ŒåŒæ ·ï¼Œå¦‚æœæ–‡ä»¶çš„ç­¾åæ˜¯é”™è¯¯çš„ï¼Œæ²¡æœ‰é€šè¿‡ç­¾åéªŒè¯ï¼Œæ˜¯ä¼šè¢«æ‹’ç»æ‰§è¡Œçš„ã€‚</p>
<pre><code class="language-shell"># ./dummy
bash: ./dummy: Permission denied

# dmesg
audit: type=1800 audit(1631788187.296:8): pid=1426 uid=1001 auid=0 ses=4 op=appraise_data cause=IMA-signature-required comm=&quot;bash&quot; name=&quot;/home/imatest/dummy&quot; dev=&quot;vda2&quot; ino=668226 res=0
</code></pre>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œé€šè¿‡å¯¹è¿™äº›è½¯ä»¶æ ˆçš„æ”¹é€ ï¼Œå¯ä»¥å¹³æ»‘è¿ç§»åˆ°å•†å¯†ç®—æ³•ï¼Œå¹¶ä¸”å®Œå…¨åŸºäºå•†å¯†ç®—æ³•æ„å»ºå‡ºIMAçš„å®‰å…¨æœºåˆ¶ï¼Œè€Œè¿™äº›æœºåˆ¶åœ¨ä»¥å‰éƒ½æ˜¯å®Œå…¨ä¸”åªèƒ½æ„å»ºåœ¨å›½é™…æ ‡å‡†çš„ç®—æ³•ä¹‹ä¸Šçš„ã€‚</p>
<footer>
<span class="copyright">Copyright Â© openanolis.cn 2023 all right reserved</span>
<pre><code class="footer-code">ä½œè€…: OpenAnolis
é“¾æ¥: https://github.com/openanolis/whitebook-shangmi
æ¥æº: OpenAnolis
æœ¬æ–‡åŸåˆ›å‘å¸ƒäºã€ŒOpenAnolisã€,è½¬è½½è¯·æ³¨æ˜å‡ºå¤„,è°¢è°¢åˆä½œ!
</code></pre>
</footer>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="kernel_dmcrypt.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="kernel_modsign.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="kernel_dmcrypt.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="kernel_modsign.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
